<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Strava OAuth2</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width" />
  <base href="/" />
  <link rel="stylesheet" type="text/css"
      href="/webjars/bootstrap/css/bootstrap.min.css" />
  <script type="text/javascript"
      src="/webjars/jquery/jquery.min.js"></script>
  <script type="text/javascript"
      src="/webjars/bootstrap/js/bootstrap.min.js"></script>
</head>

<body>

  <div class="container unauthenticated">
    <h1>Login</h1>
    With Strava: <a href="/login">click here</a>
  </div>

  <div class="container authenticated" style="display: none">

    <h1>Strava</h1>

    <input type="hidden" id="user" value="" />

    <div>
      <input type="checkbox" id="measurementSystem">Show metric? <br/>

      <button onClick="listActivities()" class="btn btn-primary">Activities</button>

      <button onClick="logout()" class="btn btn-primary">Logout</button>
    </div>

    <br/>

    <h1>Weekly</h1>

    <div class="container-fluid" id="weeklyGrid">
      <div class="row header">
        <div class="col-sm-3 col-md-3 col-lg-3 col-xl-3">
          <b>Name</b>
        </div>
        <div class="col-sm-3 col-md-3 col-lg-3 col-xl-3">
          <b>Distance</b>
        </div>
        <div class="col-sm-3 col-md-3 col-lg-3 col-xl-3">
          <b>Duration</b>
        </div>
        <div class="col-sm-3 col-md-3 col-lg-3 col-xl-3">
          <b>Elevation Gain</b>
        </div>
      </div>
    </div>

    <div>
      <h1>Total distance: <span id="totalDistance"></span></h1>
    </div>

    <script type="text/javascript"
        src="/webjars/js-cookie/js.cookie.js"></script>

  </div>

  <script type="text/javascript">

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {

        if (settings.type == 'GET' ||
            settings.type == 'POST' ||
            settings.type == 'PUT' ||
            settings.type == 'DELETE') {

          if (!(/^http:.*/.test(settings.url) ||
              /^https:.*/.test(settings.url))) {

            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-XSRF-TOKEN", Cookies.get('XSRF-TOKEN'));

            xhr.setRequestHeader("Authorization", "Bearer " + $("#user").val());
          }
        }
      }
    });

    $.get("/athleteToken", function(data) {

      $("#user").val(data.accessToken);
      $(".unauthenticated").hide();
      $(".authenticated").show();
    });

    var logout = function() {

      $.post("/logout", function() {
        $("#user").val('');
        $(".unauthenticated").show();
        $(".authenticated").hide();
      });

      return true;
    }

    var formatDuration = function (seconds) {
      var sec_num = parseInt(seconds, 10); // don't forget the second param
      var hours   = Math.floor(sec_num / 3600);
      var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
      var seconds = sec_num - (hours * 3600) - (minutes * 60);

      if (hours   < 10) {hours   = "0"+hours;}
      if (minutes < 10) {minutes = "0"+minutes;}
      if (seconds < 10) {seconds = "0"+seconds;}
      return hours+':'+minutes+':'+seconds;
    }

    var listActivities = function() {

      $.get("/athlete/activities", function(data) {

        var weeklyGrid = $("#weeklyGrid");

        $("#weeklyGrid .row:not(.header)").remove();

        var totalDistanceEl = $("#totalDistance");

        var useMetric = $("input[type=checkbox]").is(":checked");

        var totalDistance = 0;

        data.forEach(activity => {
          var row = $("<div></div>");
          row.addClass("row");
          weeklyGrid.append(row);

          var classToAdd = "col-sm-3 col-md-3 col-lg-3 col-xl-3";

          var col1 = $("<div></div>").html(activity.name);
          col1.addClass(classToAdd);
          row.append(col1);

          var distance;
          
          if (useMetric) {
            distance = activity.distance / 1000;
          } else {
            distance = activity.distance / 1609;
          }
          distance = distance.toFixed(1);
          totalDistance += parseFloat(distance);

          var col2 = $("<div></div>").html(distance);
          col2.addClass(classToAdd);
          row.append(col2);

          var col3 = $("<div></div>").html(formatDuration(activity.moving_time));
          col3.addClass(classToAdd);
          row.append(col3);

          var col4 = $("<div></div>").html(activity.total_elevation_gain);
          col4.addClass(classToAdd);
          row.append(col4);

        });

        totalDistanceEl.html(totalDistance.toFixed(1));
      });

      return true;
    }
  </script>

</body>

</html>
