<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Strava OAuth2</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width" />
  <base href="/" />
  <link rel="stylesheet" type="text/css"
      href="/webjars/bootstrap/css/bootstrap.min.css" />
  <script type="text/javascript"
      src="/webjars/jquery/jquery.min.js"></script>
  <script type="text/javascript"
      src="/webjars/bootstrap/js/bootstrap.min.js"></script>
</head>

<body>

  <div class="container unauthenticated">
    <h1>Login</h1>
    With Strava: <a href="/login">click here</a>
  </div>

  <div class="container authenticated" style="display: none">

    <h1>Strava</h1>

    <input type="hidden" id="user" value="" />

    <div>
      <input type="checkbox" id="measurementSystem">Show metric? <br/>

      <button onClick="listActivities()" class="btn btn-primary">Activities</button>

      <button onClick="logout()" class="btn btn-primary">Logout</button>
    </div>

    <br/>

    <h1>Weekly</h1>

    <table id="weeklyGrid" class="table table-bordered">
      <thead>
        <th scope="col">
          Date
        </th>
        <th scope="col">
          Name
        </th>
        <th scope="col">
          Distance
        </th>
        <th scope="col">
          Duration
        </th>
        <th scope="col">
          Average Pace
        </th>
        <th scope="col">
          Elevation Gain
        </th>
        <th scope="col">
          Link to Strava Activity
        </th>
      </thead>
    </table>

    <div>
      <h1>Total distance: <span id="totalDistance"></span></h1>
    </div>

    <script type="text/javascript"
        src="/webjars/js-cookie/js.cookie.js"></script>

  </div>

  <script type="text/javascript">

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {

        if (settings.type == 'GET' ||
            settings.type == 'POST' ||
            settings.type == 'PUT' ||
            settings.type == 'DELETE') {

          if (!(/^http:.*/.test(settings.url) ||
              /^https:.*/.test(settings.url))) {

            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-XSRF-TOKEN", Cookies.get('XSRF-TOKEN'));

            xhr.setRequestHeader("Authorization", "Bearer " + $("#user").val());
          }
        }
      }
    });

    $.get("/athleteToken", function(data) {

      $("#user").val(data.accessToken);
      $(".unauthenticated").hide();
      $(".authenticated").show();
    });

    var logout = function() {

      $.post("/logout", function() {
        $("#user").val('');
        $(".unauthenticated").show();
        $(".authenticated").hide();
      });

      return true;
    }

    var formatDuration = function (seconds) {
      var sec_num = parseInt(seconds, 10); // don't forget the second param
      var hours   = Math.floor(sec_num / 3600);
      var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
      var seconds = sec_num - (hours * 3600) - (minutes * 60);

      if (hours   < 10) {hours   = "0"+hours;}
      if (minutes < 10) {minutes = "0"+minutes;}
      if (seconds < 10) {seconds = "0"+seconds;}
      return hours+':'+minutes+':'+seconds;
    }

    var listActivities = function() {

      var userTimezoneOffsetInHours = parseInt(new Date().getTimezoneOffset() / 60);

      var listAthleteActivitiesUrl = "/athlete/activities?userTimezoneOffsetInHours=" + userTimezoneOffsetInHours;

      $.get(listAthleteActivitiesUrl, function(data) {

        var weeklyGrid = $("#weeklyGrid");

        $("table tbody tr").remove();

        var totalDistanceEl = $("#totalDistance");

        var useMetric = $("input[type=checkbox]").is(":checked");

        var totalDistance = 0;

        data.forEach(activity => {
          var row = $("<tr></tr>");
          weeklyGrid.append(row);

          var duration = activity.moving_time;

          var activityDate;
          var distance;
          
          if (useMetric) {
            activityDate = 
              activity.start_date_local.substring(8,10) + "/" + 
              activity.start_date_local.substring(5,7) + "/" + 
              activity.start_date_local.substring(0,4);
            distance = activity.distance / 1000;
          } else {
            activityDate = 
              activity.start_date_local.substring(5,7) + "/" + 
              activity.start_date_local.substring(8,10) + "/" + 
              activity.start_date_local.substring(0,4);
            distance = activity.distance / 1609;
          }

          distance = distance.toFixed(1);
          var floatDistance = parseFloat(distance);
          totalDistance += floatDistance;
          var averagePaceInSeconds = duration / floatDistance;
          averagePaceInSeconds = averagePaceInSeconds.toFixed(0);
          var averagePace = formatDuration(averagePaceInSeconds);

          var colDate = $("<td></td>").html(activityDate);
          row.append(colDate);

          var colName = $("<td></td>").html(activity.name);
          row.append(colName);

          var colDistance = $("<td></td>").html(distance);
          row.append(colDistance);

          var colDuration = $("<td></td>").html(formatDuration(duration));
          row.append(colDuration);

          var colAveragePace = $("<td></td>").html(averagePace);
          row.append(colAveragePace);

          var colElevation = $("<td></td>").html(activity.total_elevation_gain);
          row.append(colElevation);

          var activityUrl = $("<a></a>").html("Link");
          activityUrl.prop("href", "https://www.strava.com/activities/" + activity.id);
          activityUrl.prop("target", "_blank");

          var colLink = $("<td></td>");
          colLink.append(activityUrl);
          row.append(colLink);
        });

        totalDistanceEl.html(totalDistance.toFixed(1));
      });

      return true;
    }
  </script>

</body>

</html>
